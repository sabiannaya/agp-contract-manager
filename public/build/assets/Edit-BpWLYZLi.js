import{d as oe,u as ae,o as ne,a as w,q as M,w as T,c as D,b as d,e as n,f as e,h as le,g as i,i as B,j as p,t as l,k as m,l as _,m as v,n as E,F as O,r as R,p as k,s as U}from"./app-Az55F6M8.js";import{_ as I,u as P}from"./useActionConfirmation-BPstB5Uy.js";import{_ as ie}from"./Heading.vue_vue_type_script_setup_true_lang-DzT-PsX3.js";import{_ as C}from"./AppLogoIcon.vue_vue_type_script_setup_true_lang-CjG2TDFh.js";import{_ as ce,a as de,b as ue,c as me}from"./CardTitle.vue_vue_type_script_setup_true_lang-DL5VZqU4.js";import{_ as pe}from"./CurrencyInput.vue_vue_type_script_setup_true_lang-MgtW0iPC.js";import{_ as V}from"./Input.vue_vue_type_script_setup_true_lang-9NyD3cCB.js";import{_ as f}from"./Label.vue_vue_type_script_setup_true_lang-BatJIAlb.js";import{_ as S}from"./Select.vue_vue_type_script_setup_true_lang-C5fkymIU.js";import{u as _e,i as ve,a as q,_ as fe,l as be,b as ge}from"./AppLayout.vue_vue_type_script_setup_true_lang-DyTogOSr.js";import{P as ye}from"./plus-Rxuc06gk.js";import{S as xe}from"./shield-check-CeOABV_k.js";import{T as he}from"./trash-2-1tc8fb7c.js";import"./DialogTitle.vue_vue_type_script_setup_true_lang-D7dEZzdR.js";import"./useForwardPropsEmits-DcGYh6Gw.js";import"./index-Dwg1ok0u.js";import"./DialogFooter.vue_vue_type_script_setup_true_lang-CpvOfIA5.js";import"./useForwardExpose-Dz4tKeCh.js";import"./VisuallyHidden-C4XAoWlX.js";import"./VisuallyHiddenInput-dytHPRwB.js";import"./chevron-down-DzsoBm0Z.js";import"./createLucideIcon-iLJQO7DH.js";import"./check-CBSXup_1.js";import"./index-BDqSilVs.js";const Ve={class:"flex flex-col gap-6 p-6"},ke={class:"rounded-lg border bg-card p-6"},Ce={class:"grid gap-4"},$e={class:"grid grid-cols-2 gap-4"},Ue={class:"space-y-2"},Se={key:0,class:"text-sm text-destructive"},qe={class:"space-y-2"},Te={key:0,class:"text-sm text-destructive"},Ne={class:"space-y-2"},Fe={key:0,class:"text-sm text-destructive"},Ae={class:"grid grid-cols-2 gap-4"},ze={class:"space-y-2"},je={key:0,class:"text-sm text-destructive"},we={class:"space-y-2"},Me={key:0,class:"text-sm text-destructive"},De={class:"space-y-2"},Be={class:"text-xs text-muted-foreground"},Ee={key:0,class:"text-sm text-destructive"},Oe={class:"rounded-lg border bg-muted/30 p-3 text-xs text-muted-foreground"},Re={key:0,class:"space-y-4 rounded-lg border p-4"},Ie={class:"space-y-2"},Pe={key:0,class:"text-sm text-destructive"},Le={key:0,class:"space-y-2"},We={class:"flex items-center justify-between"},Ge={class:"grid grid-cols-4 gap-2"},He={class:"relative"},Je={key:0,class:"text-sm text-destructive"},Ke={class:"flex justify-end gap-2"},Qe={class:"lg:col-span-1"},Xe={class:"lg:col-span-4"},Ye={class:"lg:col-span-6"},Ze={key:0,class:"text-xs text-muted-foreground mt-1"},et={class:"flex items-end lg:col-span-1"},tt={key:0,class:"text-sm text-destructive"},st={class:"flex justify-end"},St=oe({__name:"Edit",props:{contract:{},eligibleMasters:{}},setup(L){const c=L,{t:s}=ae(),$=_e(),b=P(),g=P(),W=[{title:s("nav.contracts"),href:ve().url},{title:c.contract.number,href:q(c.contract.id).url},{title:s("common.edit"),href:"#"}],N=M([]);async function G(){const o=await fetch(be().url);N.value=await o.json()}ne(G);const F=k(()=>N.value.map(o=>({value:o.id,label:`${o.code} - ${o.name}`}))),H=k(()=>[{value:"routine",label:s("contracts.types.routine")},{value:"progress",label:s("contracts.types.progress")}]),A=k(()=>(c.eligibleMasters??[]).map(o=>({value:o.id,label:`${o.name} (${o.email})`}))),t=w({number:c.contract.number,date:String(c.contract.date).split("T")[0],vendor_id:c.contract.vendor_id,amount:Number(c.contract.amount??0),cooperation_type:c.contract.cooperation_type,term_count:c.contract.term_count,term_percentages:(c.contract.term_percentages??[]).map(o=>Number(o)),is_active:c.contract.is_active,assigned_master_user_id:c.contract.assigned_master_user_id??null}),y=M((c.contract.term_percentages??[]).map(o=>Number(o)));T(()=>t.term_count,o=>{if(o&&o>0){const r=[...y.value];if(o>r.length)for(let a=r.length;a<o;a++)r.push(0);else r.splice(o);y.value=r,t.term_percentages=r}else y.value=[],t.term_percentages=[]}),T(y,o=>{t.term_percentages=[...o]},{deep:!0});const z=k(()=>y.value.reduce((o,r)=>o+(r||0),0));function J(o){return o==null?"-":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(o)}function K(){t.put(ge(c.contract.id).url,{preserveScroll:!0,onSuccess:()=>{$.success(s("contracts.updated_successfully")),U.visit(q(c.contract.id).url)},onError:()=>{$.error(s("contracts.update_failed"))}})}function Q(){b.requestConfirmation({title:s("common.update"),description:s("contracts.edit_description"),confirmText:s("common.save"),details:[{label:s("contracts.number"),value:t.number||"-"},{label:s("contracts.vendor"),value:F.value.find(o=>o.value===t.vendor_id)?.label??"-"},{label:s("contracts.amount"),value:J(t.amount??0)}]},K)}function X(){U.get(q(c.contract.id).url)}const Y=k(()=>A.value),u=w({approvers:[]});function Z(){const o=(c.contract.approvers??[]).map((r,a)=>({user_id:r.user_id??null,sequence_no:r.sequence_no??a+1,remarks:r.remarks??"",is_master:r.is_master??!1}));u.approvers=o.length>0?o:[{user_id:null,sequence_no:1,remarks:"",is_master:!1}]}function j(){u.approvers=u.approvers.map((o,r)=>({...o,sequence_no:r+1}))}function ee(){u.approvers.push({user_id:null,sequence_no:u.approvers.length+1,remarks:"",is_master:!1})}function te(o){u.approvers[o]?.is_master||(u.approvers.splice(o,1),j())}function se(){j();const o=u.approvers.filter(r=>!r.is_master).map((r,a)=>({user_id:r.user_id,sequence_no:a+1,remarks:r.remarks}));U.post(`/contracts/${c.contract.id}/approvers`,{approvers:o},{preserveScroll:!0,onSuccess:()=>{$.success(s("contracts.approvers_updated_successfully")),U.visit(q(c.contract.id).url)},onError:()=>{$.error(s("contracts.approvers_update_failed"))}})}function re(){g.requestConfirmation({title:s("contracts.approvers"),description:"Update contract approvers and why they are required in the workflow.",confirmText:s("common.save"),details:[{label:s("contracts.contract_number"),value:c.contract.number},{label:s("contracts.approvers"),value:String(u.approvers.length)}]},se)}return T(()=>c.contract.approvers,()=>{Z()},{immediate:!0}),(o,r)=>(m(),D(fe,{breadcrumbs:W},{default:d(()=>[n(e(le),{title:`${e(s)("common.edit")} - ${c.contract.number}`},null,8,["title"]),i("div",Ve,[n(ie,{title:e(s)("contracts.edit"),description:e(s)("contracts.edit_description")},null,8,["title","description"]),i("div",ke,[i("form",{onSubmit:B(Q,["prevent"]),class:"space-y-4"},[i("div",Ce,[i("div",$e,[i("div",Ue,[n(e(f),null,{default:d(()=>[p(l(e(s)("contracts.number")),1)]),_:1}),n(e(V),{modelValue:e(t).number,"onUpdate:modelValue":r[0]||(r[0]=a=>e(t).number=a),disabled:e(t).processing},null,8,["modelValue","disabled"]),e(t).errors.number?(m(),_("p",Se,l(e(t).errors.number),1)):v("",!0)]),i("div",qe,[n(e(f),null,{default:d(()=>[p(l(e(s)("contracts.date")),1)]),_:1}),n(e(V),{modelValue:e(t).date,"onUpdate:modelValue":r[1]||(r[1]=a=>e(t).date=a),type:"date",disabled:e(t).processing},null,8,["modelValue","disabled"]),e(t).errors.date?(m(),_("p",Te,l(e(t).errors.date),1)):v("",!0)])]),i("div",Ne,[n(e(f),null,{default:d(()=>[p(l(e(s)("contracts.vendor")),1)]),_:1}),n(e(S),{modelValue:e(t).vendor_id,"onUpdate:modelValue":r[2]||(r[2]=a=>e(t).vendor_id=a),options:F.value,placeholder:e(s)("contracts.select_vendor"),disabled:e(t).processing,clearable:""},null,8,["modelValue","options","placeholder","disabled"]),e(t).errors.vendor_id?(m(),_("p",Fe,l(e(t).errors.vendor_id),1)):v("",!0)]),i("div",Ae,[i("div",ze,[n(e(f),null,{default:d(()=>[p(l(e(s)("contracts.amount")),1)]),_:1}),n(e(pe),{modelValue:e(t).amount,"onUpdate:modelValue":r[3]||(r[3]=a=>e(t).amount=a),min:0,disabled:e(t).processing},null,8,["modelValue","disabled"]),e(t).errors.amount?(m(),_("p",je,l(e(t).errors.amount),1)):v("",!0)]),i("div",we,[n(e(f),null,{default:d(()=>[p(l(e(s)("contracts.cooperation_type")),1)]),_:1}),n(e(S),{modelValue:e(t).cooperation_type,"onUpdate:modelValue":r[4]||(r[4]=a=>e(t).cooperation_type=a),options:H.value,disabled:e(t).processing},null,8,["modelValue","options","disabled"]),e(t).errors.cooperation_type?(m(),_("p",Me,l(e(t).errors.cooperation_type),1)):v("",!0)])]),i("div",De,[n(e(f),null,{default:d(()=>[p(l(e(s)("contracts.assigned_master")),1)]),_:1}),n(e(S),{modelValue:e(t).assigned_master_user_id,"onUpdate:modelValue":r[5]||(r[5]=a=>e(t).assigned_master_user_id=a),options:A.value,placeholder:e(s)("contracts.select_master"),disabled:e(t).processing,clearable:""},null,8,["modelValue","options","placeholder","disabled"]),i("p",Be,l(e(s)("contracts.master_hint")),1),e(t).errors.assigned_master_user_id?(m(),_("p",Ee,l(e(t).errors.assigned_master_user_id),1)):v("",!0)]),i("div",Oe,l(e(s)("contracts.approvers"))+": "+l(e(s)("contracts.approvers_save_separately")??"Approvers are saved separately below."),1),e(t).cooperation_type==="progress"?(m(),_("div",Re,[i("div",Ie,[n(e(f),null,{default:d(()=>[p(l(e(s)("contracts.term_count")),1)]),_:1}),n(e(V),{"model-value":e(t).term_count??void 0,"onUpdate:modelValue":r[6]||(r[6]=a=>e(t).term_count=a?Number(a):null),type:"number",min:"1",max:"12",disabled:e(t).processing},null,8,["model-value","disabled"]),e(t).errors.term_count?(m(),_("p",Pe,l(e(t).errors.term_count),1)):v("",!0)]),e(t).term_count&&e(t).term_count>0?(m(),_("div",Le,[i("div",We,[n(e(f),null,{default:d(()=>[p(l(e(s)("contracts.term_percentages")),1)]),_:1}),i("span",{class:E(["text-sm font-medium",z.value===100?"text-green-600":"text-destructive"])},l(e(s)("contracts.total"))+": "+l(z.value)+"% ",3)]),i("div",Ge,[(m(!0),_(O,null,R(y.value,(a,x)=>(m(),_("div",{key:x,class:"space-y-1"},[n(e(f),{class:"text-xs text-muted-foreground"},{default:d(()=>[p(l(e(s)("contracts.term"))+" "+l(x+1),1)]),_:2},1024),i("div",He,[n(e(V),{modelValue:y.value[x],"onUpdate:modelValue":h=>y.value[x]=h,modelModifiers:{number:!0},type:"number",min:"0",max:"100",class:"pr-6",disabled:e(t).processing},null,8,["modelValue","onUpdate:modelValue","disabled"]),r[9]||(r[9]=i("span",{class:"absolute right-2 top-1/2 -translate-y-1/2 text-sm text-muted-foreground"},"%",-1))])]))),128))]),e(t).errors.term_percentages?(m(),_("p",Je,l(e(t).errors.term_percentages),1)):v("",!0)])):v("",!0)])):v("",!0)]),i("div",Ke,[n(e(C),{type:"button",variant:"outline",onClick:X,disabled:e(t).processing},{default:d(()=>[p(l(e(s)("common.cancel")),1)]),_:1},8,["disabled"]),n(e(C),{type:"submit",disabled:e(t).processing},{default:d(()=>[p(l(e(t).processing?e(s)("common.saving"):e(s)("common.save")),1)]),_:1},8,["disabled"])])],32)]),n(e(ce),null,{default:d(()=>[n(e(de),null,{default:d(()=>[n(e(ue),{class:"flex items-center justify-between gap-2"},{default:d(()=>[i("span",null,l(e(s)("contracts.approvers")),1),n(e(C),{type:"button",variant:"outline",size:"sm",onClick:ee,disabled:e(u).processing},{default:d(()=>[n(e(ye),{class:"mr-1 size-4"}),p(" "+l(e(s)("common.create")),1)]),_:1},8,["disabled"])]),_:1})]),_:1}),n(e(me),null,{default:d(()=>[i("form",{class:"space-y-3",onSubmit:B(re,["prevent"])},[(m(!0),_(O,null,R(e(u).approvers,(a,x)=>(m(),_("div",{key:`approver-row-${x}`,class:E(["grid gap-3 rounded-md border p-3 lg:grid-cols-12",a.is_master?"bg-muted/40":""])},[i("div",Qe,[n(e(f),null,{default:d(()=>[...r[10]||(r[10]=[p("Seq",-1)])]),_:1}),n(e(V),{"model-value":a.sequence_no,disabled:""},null,8,["model-value"])]),i("div",Xe,[n(e(f),null,{default:d(()=>[p(l(e(s)("nav.users")),1)]),_:1}),n(e(S),{modelValue:a.user_id,"onUpdate:modelValue":h=>a.user_id=h,options:Y.value,placeholder:e(s)("common.select"),disabled:e(u).processing||a.is_master,clearable:!a.is_master},null,8,["modelValue","onUpdate:modelValue","options","placeholder","disabled","clearable"])]),i("div",Ye,[n(e(f),null,{default:d(()=>[...r[11]||(r[11]=[p("Remarks",-1)])]),_:1}),n(e(V),{modelValue:a.remarks,"onUpdate:modelValue":h=>a.remarks=h,placeholder:"Why this approver is required",disabled:e(u).processing||a.is_master},null,8,["modelValue","onUpdate:modelValue","disabled"]),a.is_master?(m(),_("p",Ze,[n(e(xe),{class:"inline size-3 mr-0.5"}),p(" "+l(e(s)("contracts.contract_master")),1)])):v("",!0)]),i("div",et,[a.is_master?v("",!0):(m(),D(e(C),{key:0,type:"button",variant:"ghost",size:"icon",disabled:e(u).processing,onClick:h=>te(x)},{default:d(()=>[n(e(he),{class:"size-4"})]),_:1},8,["disabled","onClick"]))])],2))),128)),e(u).errors.approvers?(m(),_("p",tt,l(e(u).errors.approvers),1)):v("",!0),i("div",st,[n(e(C),{type:"submit",disabled:e(u).processing},{default:d(()=>[p(l(e(u).processing?e(s)("common.saving"):e(s)("common.save")),1)]),_:1},8,["disabled"])])],32)]),_:1})]),_:1})]),n(I,{open:e(b).open.value,"onUpdate:open":r[7]||(r[7]=a=>e(b).open.value=a),title:e(b).title.value,description:e(b).description.value,"confirm-text":e(b).confirmText.value,"cancel-text":e(b).cancelText.value,destructive:e(b).destructive.value,details:e(b).details.value,onConfirm:e(b).confirm,onCancel:e(b).cancel},null,8,["open","title","description","confirm-text","cancel-text","destructive","details","onConfirm","onCancel"]),n(I,{open:e(g).open.value,"onUpdate:open":r[8]||(r[8]=a=>e(g).open.value=a),title:e(g).title.value,description:e(g).description.value,"confirm-text":e(g).confirmText.value,"cancel-text":e(g).cancelText.value,destructive:e(g).destructive.value,details:e(g).details.value,onConfirm:e(g).confirm,onCancel:e(g).cancel},null,8,["open","title","description","confirm-text","cancel-text","destructive","details","onConfirm","onCancel"])]),_:1}))}});export{St as default};
